name: CI/CD Pipeline
on:
 push:
  branches: [main, develop]
 pull_request:
  branches: [main, develop]

env:
  DOTNET_VERSION: '9.0.x'

jobs:
    build:  
      runs-on: ubuntu-latest

      steps:
          - name: Checkout
            uses: actions/checkout@v4

          - name: Setup .NET
            uses: actions/setup-dotnet@v4
            with:
              dotnet-version: ${{ env.DOTNET_VERSION }}
          
          - name: Cache NuGet packages
            uses: actions/cache@v4
            with:
                path: ~/.nuget/packages
                key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json', '**/*.csproj') }}
                restore-keys: |
                    ${{ runner.os }}-nuget-
          
          - name: Restore
            run: dotnet restore backend/EducaOnline.sln

          - name: Build
            run: dotnet build backend/EducaOnline.sln -c Release --no-restore

    docker-build-push:
        name: Build e Push Docker
        runs-on: ubuntu-latest
        needs: build
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
        strategy:
            matrix:
                include:
                     - service: identidade-api
                       dockerfile: backend/src/services/EducaOnline.Identidade.API/Dockerfile
                       context: backend
                     - service: conteudo-api
                       dockerfile: backend/src/services/EducaOnline.Conteudo.API/Dockerfile
                       context: backend
                     - service: aluno-api
                       dockerfile: backend/src/services/EducaOnline.Aluno.API/Dockerfile
                       context: backend
                     - service: pedidos-api
                       dockerfile: backend/src/services/EducaOnline.Pedidos.API/Dockerfile
                       context: backend
                     - service: financeiro-api
                       dockerfile: backend/src/services/EducaOnline.Financeiro.API/Dockerfile
                       context: backend
                     - service: bff
                       dockerfile: backend/src/api_gateways/EducaOnline.Bff/Dockerfile
                       context: backend

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Login Docker Hub
              uses: docker/login-action@v3
              with:
               username: ${{ secrets.DOCKERHUB_USERNAME }}
               password: ${{ secrets.DOCKERHUB_TOKEN }}

            - name: Build e Push
              uses: docker/build-push-action@v5
              with:
               context: ${{ matrix.context }}
               file: ${{ matrix.dockerfile }}
               push: true
               tags: ${{ secrets.DOCKERHUB_USERNAME }}/meu-projeto-${{ matrix.service }}:latest
 